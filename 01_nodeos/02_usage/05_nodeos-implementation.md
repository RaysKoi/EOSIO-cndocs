# Nodeos的实现
---

EOSIO平台为交易生命周期各阶段提供不同的数据结构存储区块链信息。本节将介绍其中一些数据结构设计。其中，生产者节点是有当前创建区块链区块的区块生产者运行的`nodeos`实例。注意，生产者每6秒变动一次，期间顺序生成12个区块。

## 区块链状态和存储

每个`nodeos`实例将创建一些用于维护区块链状态的内部文件。这些文件位于安装目录下的`~/eosio/nodeos/data`中，分别用于：

* `block.log`是写入磁盘的只添加区块日志，包含所有不可篡改的区块。
* `reversible_blocks`是内存映射文件，包含已写入区块链但是尚未形成不可篡改的区块 
* `区块链状态`（或`数据库` ）是内存映射文件，用于缓存每个区块的区块链状态，包括账户细节、延期交易、交易、智能合约中使用多索引表存储的数据等。一定区块形成不可篡改，无需缓存区块链状态。
* `待处理区块`是内存中区块，其中包含处理添加到区块中的交易，并将最终形成`链头区块`。如果`nodeos`实例正在生成区块，那么将发送待处理区块给其它`nodeos`示例。
* `链头区块`是将最新写入区块链的区块，存储在`reversible_blocks`中。

## Nodeos读取模式

EOSIO提供多个[服务和接口](https://developers.eos.io/eosio-cpp/docs/db-api)，支持智能合约开发者持久化操作乃至交易和边界间的状态。智能合约普遍使用了这些服务和接口。例如，`eosio.token`合约维护数据库中所有用户的账户状态。

每个`nodeos`实例在内存中维护数据库，支持智能合约读写数据。`nodeos`还提供访问数据库读取数据的HTTP RPC API。

EOSIO支持通过多种方式查询访问数据：

- `观望模式`：涵盖已确认和未确认交易。
- `链头模式`：只涵盖已确认交易，处理未确认交易，但是并未涵盖其中；
- `只读模式`: 只涵盖已确认交易；
- `不可篡改模式`: 只涵盖最新生成区块中不可篡改的已确认交易。

交易一旦被`nodeos`实例接收、处理并在区块中写回区块链，就认为该交易已确认。即交易已添加到链头区块乃至更早的区块中。


### 观望模式

客户端（例如`cleos`等）和RPC API所看到的数据库状态，是链头区块当前状态加上该节点知悉的所有交易所做的更改，这些更改可能并未上链，例如未确认交易等情况。

观望模式延迟低，但是易于出错。该模式不保证交易所体现的状态会添加到区块链中，也不保证所体现的交易顺序是最终链上确认顺序。

该模式主要优点是延迟低，但是状态数据的一致性最差。

在观望模式下，`nodeos`可以执行在节点看来是最优分叉中经PoS经验证的任一区块中的交易。


### 链头模式

客户端（例如`cleos`等）和RPC API所看到的数据库状态，是区块链中当前链头区块的状态。鉴于当前链头区块尚未形成不可篡改区块，并可能短时间内存在链分叉可能，在链头模式下读取的状态可能由于`nodeos`分叉切换而导致不准确。注意，观望模式存在同样的问题。

该模式优点是在数据一致性视图和延迟间取得和很好的权衡。

在该模式下，`nodeos`可以执行在节点看来是最优分叉中经PoS经验证的任一区块中的交易。


### 只读模式

客户端（例如`cleos`等）和RPC API所看到的数据库状态，是区块链中当前链头区块的状态。该模式并不反映尚未上链但是当前节点可见的交易所产生的更改，例如未确认交易。


### 不可篡改模式

一旦`nodeos`配置未不可篡改读取模式，尽管节点将追踪分叉链中的最新区块情况，但是状态变化将滞后于当前最优链头区块（也称为分叉链头数据库）。该模式总是给出最新不可篡改区块的状态。

客户端（例如`cleos`等）和RPC API所看到的数据库状态，是区块链中当前链头区块的状态。该模式并不反映尚未上链但是当前节点可见的交易所产生的更改，例如未确认交易。


## 如何指定读取模式

`nodeos`的运行模式由`eosio::chain_plugin`插件的`--read-mode`选项指定。

